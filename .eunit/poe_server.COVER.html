<html>
<head><title>.eunit/poe_server.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/odo/2f/poe/.eunit/poe_server.erl by COVER 2013-01-17 at 22:13:24

****************************************************************************

        |  %% @doc: server managing instances of appendix_server
        |  %% and dispatching read and write requests.
        |  
        |  -module(poe_server).
        |  -behaviour(gen_server).
        |  
        |  %% API
        |  -export([start_link/1, stop/1]).
        |  -export([
        |      create_partition/1
        |      , maybe_create_new_partitions/0
        |      , topics/0
        |      , write_pid/1
        |      , read_pid/2
        |      ]).
        |  
        |  %% gen_server callbacks
        |  -export([
        |      init/1
        |      , handle_call/3
        |      , handle_cast/2
        |      , handle_info/2
        |      , terminate/2
        |      , code_change/3]).
        |  
        |  -define(SERVER, ?MODULE).
        |  
        |  -record(state, {base_dir, pid_table, ref_table, topics}).
        |  
        |  %%%===================================================================
        |  %%% API
        |  %%%===================================================================
        |  
        |  start_link(BaseDir) -&gt;
     5..|      gen_server:start_link({local, ?SERVER}, ?MODULE, [BaseDir], []).
        |  
        |  create_partition(Topic) -&gt;
     4..|      gen_server:call(?SERVER, {create_partition, Topic}).
        |  
        |  topics() -&gt;
     3..|      gen_server:call(?SERVER, {topics}).
        |  
        |  maybe_create_new_partitions() -&gt;
<font color=red>     0..|      gen_server:call(?SERVER, {maybe_create_new_partitions}).</font>
        |  
        |  stop(Pid) -&gt;
<font color=red>     0..|      gen_server:call(Pid, stop).</font>
        |  
        |  % server  1           2
        |  %         |-----|     |-------|
        |  % A       !   ? 
        |  % B                ?  !
        |  % C                   !          ?
        |  % D ?     !
        |  read_pid(Topic, Timestamp) -&gt;
     9..|      case prev_server(Topic, Timestamp) of
        |          PidPrev when is_pid(PidPrev) -&gt;
     2..|              case pointer_high(PidPrev) &gt; Timestamp of
        |                  % case A
        |                  true -&gt;
<font color=red>     0..|                      PidPrev;</font>
        |                  false -&gt;
<font color=red>     0..|                      case next_server(Topic, Timestamp) of</font>
        |                          % case B
        |                          PidNext when is_pid(PidNext) -&gt;
<font color=red>     0..|                              PidNext;</font>
        |                          % case C
        |                          not_found -&gt;
<font color=red>     0..|                              PidPrev</font>
        |                      end
        |              end;
        |          not_found -&gt;
        |              % case D
     7..|              next_server(Topic, Timestamp)
        |      end.
        |  
        |  prev_server(Topic, Timestamp) -&gt;
     9..|      case ets:prev(poe_ref_table, {Topic, Timestamp}) of
        |          Key = {Topic, _} -&gt;
     2..|              [{Key, Pid}] = ets:lookup(poe_ref_table, Key),
     2..|              Pid;
        |          _ -&gt; 
     7..|              not_found
        |          end.
        |  
        |  next_server(Topic, Timestamp) -&gt;
     7..|      case ets:next(poe_ref_table, {Topic, Timestamp}) of
        |          Key = {Topic, _} -&gt;
     6..|              [{Key, Pid}] = ets:lookup(poe_ref_table, Key),
     6..|              Pid;
        |          _ -&gt; 
     1..|              not_found
        |          end.
        |  
        |  pointer_high(Pid) -&gt;
     2..|      Key = {{p,l,appendix_server},Pid},
     2..|      [{Key, Pid, Data}] = ets:lookup(gproc, Key),
<font color=red>     0..|      proplists:get_value(pointer_high, Data).</font>
        |  
        |  write_pid(Topic) -&gt;
        |      % see if we have that topic, if not, create a writer
     6..|      case ets:match(poe_ref_table, {{Topic, '_'}, '$1'}) of
        |          [] -&gt;
     4..|              create_partition(Topic);
        |          Pids -&gt;
     2..|              hd(lists:last(Pids))
        |      end.
        |  
        |  %%%===================================================================
        |  %%% gen_server callbacks
        |  %%%===================================================================
        |  
        |  init([BaseDir]) -&gt;
     5..|      file:make_dir(BaseDir),
     5..|      file:make_dir(topics_dir(BaseDir)),
     5..|      PidTable = ets:new(poe_pid_table, [set, protected, named_table]),
     5..|      RefTable = ets:new(poe_ref_table, [ordered_set, protected, named_table]),
     5..|      start_from_dir(BaseDir),
     5..|      {ok, #state{base_dir = BaseDir, pid_table = PidTable, ref_table = RefTable, topics = []}}.
        |  
        |  handle_call({create_partition, Topic}, _From, State = #state{topics = Topics}) -&gt;
     4..|      Now = timestamp(),
     4..|      Signature = {Topic, Now},
     4..|      TopicsDir = topics_dir(State#state.base_dir),
     4..|      TopicDir = TopicsDir ++ binary_to_list(Topic),
     4..|      file:make_dir(TopicsDir),
     4..|      file:make_dir(TopicDir),
     4..|      Pid = start_and_register_server(TopicDir ++ "/" ++ integer_to_list(Now), Signature),
     4..|      {reply, Pid, State#state{topics = [Topic|Topics]}};
        |  
        |  handle_call({maybe_create_new_partitions}, _From, State = #state{topics = Topics}) -&gt;
<font color=red>     0..|      Servers = appendix_server:servers(),</font>
<font color=red>     0..|      MCNP = fun(T, Acc) -&gt;</font>
<font color=red>     0..|          case maybe_create_new_partition(T, Servers) of</font>
        |              true -&gt;
<font color=red>     0..|                  [T|Acc];</font>
        |              false -&gt;
<font color=red>     0..|                  Acc</font>
        |          end
        |      end, 
<font color=red>     0..|      TopicsWithNewPartitions = lists:foldl(MCNP, [], Topics),</font>
<font color=red>     0..|      {reply, TopicsWithNewPartitions, State};</font>
        |  
        |  handle_call({topics}, _From, State = #state{topics = Topics}) -&gt;
     3..|      {reply, Topics, State}.
        |  
        |  handle_cast(_Msg, State) -&gt;
<font color=red>     0..|      {noreply, State}.</font>
        |  
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|      {noreply, State}.</font>
        |  
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|      ok.</font>
        |  
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|      {ok, State}.</font>
        |  
        |  %%%===================================================================
        |  %%% utilities
        |  %%%===================================================================
        |  
        |  topics_dir(BaseDir) -&gt;
    14..|      BaseDir ++ "/" ++ "topics/".
        |  
        |  start_and_register_server(Path, Signature) -&gt;
     4..|      {ok, Pid} = poe_appendix_sup:start_child(Path),
     4..|      ets:insert(poe_pid_table, {Pid, Signature}),
     4..|      ets:insert(poe_ref_table, {Signature, Pid}),
     4..|      Pid.
        |  
        |  start_from_dir(BaseDir) -&gt;
     5..|      PathsAndSigs = find_paths_and_signatures(BaseDir),
     5..|      Register = fun(Path, Signature = {Topic, _}) -&gt;
<font color=red>     0..|          start_and_register_server(Path, Signature),</font>
<font color=red>     0..|          Topic</font>
        |      end,   
     5..|      [Register(Path, Signature)||{Path, Signature}&lt;-PathsAndSigs].
        |  
        |  find_paths_and_signatures(BaseDir) -&gt;
     5..|      TopicsDir = topics_dir(BaseDir),
     5..|      {ok, Topics} = file:list_dir(TopicsDir),
     5..|      PathAndSigFromTopic = fun(Topic) -&gt;
<font color=red>     0..|          {ok, Files} = file:list_dir(TopicsDir ++ Topic),</font>
<font color=red>     0..|          PathAndSig = fun(File, Acc) -&gt;</font>
<font color=red>     0..|              case binary:split(list_to_binary(File), &lt;&lt;"_"&gt;&gt;) of</font>
        |                  [Time, &lt;&lt;"index"&gt;&gt;] -&gt;
<font color=red>     0..|                      [{TopicsDir ++ Topic ++ "/" ++ binary_to_list(Time), {list_to_binary(Topic), list_to_integer(binary_to_list(Time))}}, Acc];</font>
        |                  _ -&gt;
<font color=red>     0..|                      Acc</font>
        |              end
        |          end,
<font color=red>     0..|          lists:foldl(PathAndSig, [], Files)</font>
        |      end,
     5..|      lists:flatten([PathAndSigFromTopic(T)||T&lt;-Topics]).
        |  
        |  timestamp() -&gt;
     4..|      {MegaSecs, Secs, MicroSecs} = now(),
     4..|      (MegaSecs * 1000000 + Secs) * 1000000 + MicroSecs.
        |  
        |  maybe_create_new_partition(Topic, Servers) -&gt;
<font color=red>     0..|      io:format("Servers:~p\n", [Servers]),</font>
<font color=red>     0..|      ServerData = [Data||{Data, Pid}&lt;-Servers, Pid =:= write_pid(Topic)],</font>
<font color=red>     0..|      io:format("ServerData for ~p :~p\n", [Topic, ServerData]),</font>
<font color=red>     0..|      true.</font>
        |  
</pre>
</body>
</html>
