<html>
<head><title>.eunit/poe_listener.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/odo/2f/poe/.eunit/poe_listener.erl by COVER 2013-01-17 at 22:13:24

****************************************************************************

        |  -module(poe_listener).
        |  -export([start_link/4, init/4]).
        |  
        |  start_link(ListenerPid, Socket, Transport, Opts) -&gt;
<font color=red>     0..|  	Pid = spawn_link(?MODULE, init, [ListenerPid, Socket, Transport, Opts]),</font>
<font color=red>     0..|  	{ok, Pid}.</font>
        |  
        |  init(ListenerPid, Socket, Transport, _Opts = []) -&gt;
<font color=red>     0..|  	ok = ranch:accept_ack(ListenerPid),</font>
<font color=red>     0..|  	loop(Socket, Transport).</font>
        |  
        |  loop(Socket, ranch_tcp) -&gt;
<font color=red>     0..|  	case ranch_tcp:recv(Socket, 0, infinity) of</font>
        |  		{ok, Data} -&gt;
<font color=red>     0..|  			Reply = case poe_protocol:decode_request(Data) of</font>
        |  				unknown_command -&gt;
<font color=red>     0..|  					ranch_tcp:send(Socket, &lt;&lt;"unknown_command\n"&gt;&gt;);</font>
        |  				{request_pointer, Topic, Pointer, Limit} -&gt;
<font color=red>     0..|  					Server = poe_server:read_pid(Topic, Pointer),</font>
<font color=red>     0..|  					{FileName, Position, Length} = appendix_server:file_pointer(Server, Pointer, Limit),</font>
<font color=red>     0..|  					{ok, File} = file:open(FileName, [raw, binary]),</font>
<font color=red>     0..|  					{ok, _BytesSent} = file:sendfile(File, Socket, Position, Length, []),</font>
<font color=red>     0..|  					file:close(File)</font>
        |  			end,
<font color=red>     0..|  			error_logger:info_msg("Reply:", [Reply]),</font>
<font color=red>     0..|  			loop(Socket, ranch_tcp);</font>
        |  		_ -&gt;
<font color=red>     0..|  			ok = ranch_tcp:close(Socket)</font>
        |  	end.</pre>
</body>
</html>
